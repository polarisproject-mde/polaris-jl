<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Polaris - Iniciar Sesi√≥n</title>
    <link rel="icon" href="/static/img/polaris.svg">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/login.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Winky+Rough:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
</head>
<body>
    <canvas id="stars"></canvas>
    
    <a href="{{ url_for('index') }}" class="back-button">‚Üê Volver</a>

    <div class="login-container">
        <div class="logo-container">
            <!-- LOGO SVG AQU√ç -->
        </div>

        <h2 class="form-title">Iniciar Sesi√≥n</h2>

        <div class="error-message" id="errorMessage" style="display: none;"></div>
        <div class="success-message" id="successMessage" style="display: none;"></div>

        <!-- üî• ELIMINAR action="/login" para manejarlo con JS -->
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label for="Gmail">Correo Electr√≥nico</label>
                <input type="email" id="Gmail" name="Gmail" placeholder="tu@email.com" required>
            </div>

            <div class="form-group">
                <label for="contrase√±a">Contrase√±a</label>
                <div class="password-wrapper">
                    <input type="password" id="contrase√±a" name="contrase√±a" placeholder="Ingresa tu contrase√±a" required>
                    <button type="button" class="password-toggle" onclick="togglePassword()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M2.458 12C3.732 7.943 7.523 5 
                                    12 5c4.477 0 8.268 2.943 9.542 
                                    7-1.274 4.057-5.065 7-9.542 
                                    7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="form-options">
                <div class="remember-me">
                    <input type="checkbox" id="remember" name="remember">
                    <label for="remember">Recordarme</label>
                </div>
                <a href="#" class="forgot-password">¬øOlvidaste tu contrase√±a?</a>
            </div>

            <button type="submit" class="login-btn" id="loginBtn">
                <span id="btnText">Iniciar Sesi√≥n</span>
                <span id="btnLoader" style="display: none;">‚è≥ Ingresando...</span>
            </button>
        </form>

        <p class="register-link">
            ¬øNo tienes cuenta? <a href="{{ url_for('register') }}">Reg√≠strate aqu√≠</a>
        </p>
    </div>

    <script>
        function togglePassword() {
            const passwordInput = document.getElementById('contrase√±a');
            const toggleButton = document.querySelector('.password-toggle');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                    </svg>
                `;
            } else {
                passwordInput.type = 'password';
                toggleButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M2.458 12C3.732 7.943 7.523 5 
                                12 5c4.477 0 8.268 2.943 9.542 
                                7-1.274 4.057-5.065 7-9.542 
                                7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                `;
            }
        }

        function showMessage(message, type = 'error') {
            const errorMsg = document.getElementById('errorMessage');
            const successMsg = document.getElementById('successMessage');
            
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            if (type === 'error') {
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';
            } else {
                successMsg.textContent = message;
                successMsg.style.display = 'block';
            }
        }

        // üî• NUEVO: LOGIN CON FETCH API
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault(); // Prevenir env√≠o tradicional
            
            const btnText = document.getElementById('btnText');
            const btnLoader = document.getElementById('btnLoader');
            const loginBtn = document.getElementById('loginBtn');
            
            // Mostrar loading
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline';
            loginBtn.disabled = true;
            
            // Obtener datos del formulario
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include', // üî• CR√çTICO para cookies
                    redirect: 'manual' // üî• No seguir redirects autom√°ticamente
                });
                
                // üî• Si es redirect (303), ir al home
                if (response.type === 'opaqueredirect' || response.status === 303 || response.status === 0) {
                    showMessage('‚úÖ Inicio de sesi√≥n exitoso. Redirigiendo...', 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 500);
                    return;
                }
                
                // Si es 200, verificar si hay error en el HTML
                if (response.ok) {
                    const html = await response.text();
                    
                    // Si el HTML contiene la palabra "error" o "incorrectos"
                    if (html.includes('error') || html.includes('incorrectos')) {
                        showMessage('‚ùå Correo o contrase√±a incorrectos', 'error');
                        btnText.style.display = 'inline';
                        btnLoader.style.display = 'none';
                        loginBtn.disabled = false;
                    } else {
                        // Login exitoso
                        showMessage('‚úÖ Inicio de sesi√≥n exitoso. Redirigiendo...', 'success');
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 500);
                    }
                } else {
                    showMessage('‚ùå Error al iniciar sesi√≥n. Intenta nuevamente.', 'error');
                    btnText.style.display = 'inline';
                    btnLoader.style.display = 'none';
                    loginBtn.disabled = false;
                }
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('‚ùå Error de conexi√≥n. Verifica tu internet.', 'error');
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
                loginBtn.disabled = false;
            }
        });

        // Efectos de focus en los inputs
        document.querySelectorAll('.form-group input').forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.style.transform = 'scale(1.02)';
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.style.transform = 'scale(1)';
            });
        });
    </script>
    
    <script src="/static/js/fondo.js"></script>
</body>
</html>